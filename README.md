Промт на русском:
"Ты — опытный разработчик, и я хочу, чтобы ты создал мессенджер 'NexChat' с минималистичным дизайном, вдохновленным Telegram, с расширенными функциями и панелью управления в стиле Rocket.Chat. Мессенджер поддерживает медиа, пользовательские стикеры и кастомные звуки уведомлений. ТЗ разбито на этапы и подэтапы. После каждого подэтапа делай чекпоинт: пиши тест (Jest), тщательно тестируй, регистрируй результат в progress.json. Если в подэтапе нужно редактировать файл из предыдущего подэтапа, уведомляй меня: 'Изменяется файл [имя] из подэтапа [номер]'. Вот детальное ТЗ:

Техническое задание (ТЗ):
Этап 1: Базовый сервер и API для чатов
1.1. Настройка сервера и авторизации
1.1.1. Инициализация сервера:
Установи Node.js (v18+), Express (v4.18), WebSocket (ws v8.14).
Настрой SQLite (sqlite3) с таблицами: users, chats, chat_members, messages, reactions, stickers.
Запусти сервер на порту 3000 (/src/server.js).
Чекпоинт: Тест на запуск сервера (GET / → 200 OK), запись в progress.json.
1.1.2. Реализация авторизации:
API:
POST /api/auth/register: создание пользователя с JWT (jsonwebtoken v9.0), генерация ключей шифрования (libsodium).
POST /api/auth/login: вход с JWT.
Таблица users: поля transcribeVoice (BOOLEAN DEFAULT 0), notificationSoundUrl (TEXT).
WebSocket: подключение с токеном (?token=<jwt>), событие 'connected'.
Чекпоинт: Тесты на регистрацию (201), вход (200), ошибки (400, 409, 401), запись в progress.json.
1.2. Личные чаты
1.2.1. Создание личных чатов:
API: POST /api/chat/personal: создание чата между двумя пользователями.
Таблица chats: type='personal', запись в chat_members.
Чекпоинт: Тест на создание чата (200), ошибки (400, 409), запись в progress.json.
1.2.2. Отправка текстовых сообщений:
API: POST /api/message: отправка текста с шифрованием (libsodium).
WebSocket: 'new_message', 'message_read'.
Чекпоинт: Тест на отправку сообщения (200), ошибки (403, 404), WebSocket-события, запись в progress.json.
1.2.3. Получение сообщений:
API: GET /api/chat/:id/messages: список сообщений с пагинацией (limit, offset).
Чекпоинт: Тест на получение сообщений (200), пагинацию, ошибки (404), запись в progress.json.
1.3. Групповые чаты
1.3.1. Создание групповых чатов:
API: POST /api/chat/group: создание группы с именем и участниками.
Таблица chats: type='group', запись в chat_members (admin для создателя).
Чекпоинт: Тест на создание группы (200), ошибки (400), запись в progress.json.
1.3.2. Модерация и закрепление сообщений:
API: POST /api/chat/:id/moderate, POST /api/chat/:id/pin.
WebSocket: 'message_deleted', 'user_banned', 'message_pinned' и др.
Чекпоинт: Тесты на модерацию (200), закрепление (200), ошибки (403, 404), WebSocket, запись в progress.json.
1.3.3. Получение информации о группе:
API: GET /api/chat/:id: данные группы.
Чекпоинт: Тест на получение данных (200), ошибки (404), запись в progress.json.
1.4. Добавление файлов, медиа и стикеров
1.4.1. Загрузка медиа:
API: POST /api/chat/:id/file: загрузка (≤ 2 ГБ), ffmpeg для duration, STT для голосовых.
WebSocket: 'new_file'.
Чекпоинт: Тест на загрузку (200), ошибки (413, 415), WebSocket, запись в progress.json.
1.4.2. Управление стикерами:
API: POST /api/sticker (PNG/GIF, ≤ 512 КБ), GET /api/stickers.
Отправка: POST /api/message с stickerId.
WebSocket: 'sticker_added'.
Чекпоинт: Тесты на загрузку стикера (200), список (200), отправку (200), ошибки (413, 415), запись в progress.json.
1.4.3. Скачивание файлов:
API: GET /api/file/:messageId, GET /api/sticker/:stickerId.
Чекпоинт: Тест на скачивание (200), ошибки (404), запись в progress.json.
1.5. Система аватарок, реакции и уведомления
1.5.1. Аватарки:
API: POST /api/user/avatar, POST /api/chat/:id/avatar (PNG/JPG, ≤ 5 МБ).
WebSocket: 'avatar_updated'.
Чекпоинт: Тест на загрузку (200), ошибки (413, 415), WebSocket, запись в progress.json.
1.5.2. Реакции:
API: POST /api/message/:id/reaction (эмодзи, ≤ 10 символов).
WebSocket: 'reaction_added', 'reaction_removed'.
Чекпоинт: Тест на добавление реакции (200), ошибки (403, 404), WebSocket, запись в progress.json.
1.5.3. Кастомные звуки уведомлений:
API: POST /api/user/notification-sound (MP3/WAV, ≤ 1 МБ, ≤ 5 сек).
WebSocket: 'notification_sound_updated', 'notification'.
Чекпоинт: Тест на загрузку звука (200), ошибки (413, 415, 400), WebSocket, запись в progress.json.
Этап 2: Логика ботов и интеграция с n8n
2.1. Создание ботов
2.1.1. Регистрация ботов: API: POST /api/bot, запись в bots и chat_members.
Чекпоинт: Тест на создание (200), ошибки (403, 404), запись в progress.json.
2.1.2. Получение списка ботов: API: GET /api/chat/:id/bots.
Чекпоинт: Тест на получение (200), ошибки (404), запись в progress.json.
2.2. Конструктор ботов
2.2.1. Добавление команд: API: POST /api/bot/:id/command, таблица bot_commands.
Чекпоинт: Тест на добавление (200), ошибки (403, 409), запись в progress.json.
2.2.2. Обработка команд: Логика обработки /command, WebSocket: 'command_executed'.
Чекпоинт: Тест на выполнение команды (200), WebSocket, запись в progress.json.
2.3. Интеграция с n8n
2.3.1. Настройка Webhook: API: POST /api/bot/:id/webhook, таблица bot_webhooks.
Чекпоинт: Тест на настройку (200), ошибки (400, 403), запись в progress.json.
2.3.2. OAuth и выполнение: API: POST /api/bot/:id/n8n-auth, вызов Webhook, WebSocket: 'webhook_response'.
Чекпоинт: Тест на авторизацию (200), выполнение (200), ошибки (401), запись в progress.json.
Этап 3: 'Эхо-пространство'
3.1. Классификация сообщений
3.1.1. Создание записи: API: POST /api/echo, таблица echo_space.
Чекпоинт: Тест на создание (200), ошибки (403, 404), запись в progress.json.
3.1.2. Логика классификации: Задача/идея/заметка, WebSocket: 'echo_created'.
Чекпоинт: Тест на классификацию (200), WebSocket, запись в progress.json.
3.2. Хранение и синхронизация
3.2.1. Получение записей: API: GET /api/chat/:id/echo.
Чекпоинт: Тест на получение (200), фильтры, запись в progress.json.
3.2.2. Удаление записей: API: DELETE /api/echo/:id, WebSocket: 'echo_deleted'.
Чекпоинт: Тест на удаление (200), ошибки (403, 404), WebSocket, запись в progress.json.
3.3. Интерактивные функции
3.3.1. Голосование: API: POST /api/echo/:id/vote, таблица echo_votes, WebSocket: 'vote_updated'.
Чекпоинт: Тест на голосование (200), ошибки (403, 404), WebSocket, запись в progress.json.
3.3.2. Теги и уведомления: API: POST /api/echo/:id/tag, уведомления ('task_reminder'), WebSocket: 'tag_added'.
Чекпоинт: Тест на теги (200), уведомления, WebSocket, запись в progress.json.
Этап 4: Звонки через WebRTC
4.1. Индивидуальные голосовые звонки
4.1.1. Инициация звонка: API: POST /api/call, таблица calls.
Чекпоинт: Тест на создание (200), ошибки (400, 409), запись в progress.json.
4.1.2. Управление звонком: API: POST /api/call/:id/answer, POST /api/call/:id/end, WebSocket: 'call_offer', 'call_ended'.
Чекпоинт: Тест на управление (200), WebSocket, запись в progress.json.
4.2. Видеозвонки
4.2.1. Включение видео: API: POST /api/call/:id/video, WebSocket: 'video_state_changed'.
Чекпоинт: Тест на видео (200), ошибки (404, 409), WebSocket, запись в progress.json.
4.3. Групповые звонки
4.3.1. Присоединение к звонку: API: POST /api/call/group/:chatId/join, таблицы group_calls, call_participants.
Чекпоинт: Тест на подключение (200), ошибки (403, 409), запись в progress.json.
4.3.2. Управление участниками: API: POST /api/call/:id/leave, WebSocket: 'participant_joined', 'active_speaker'.
Чекпоинт: Тест на управление (200), WebSocket, запись в progress.json.
Этап 5: Frontend на React Native
Общее описание:
Стиль: светлая (#FFFFFF фон, #000000 текст, #007AFF акцент), тёмная (#1C2526 фон, #E8ECEF текст, #00C4CC акцент).
Шрифт: Roboto (Regular 16px, Medium 16px, Bold 18px), подписи 14px.
Анимации: переходы 300ms (Easing.ease), fade-in 200ms.
5.1. Экран авторизации и регистрации
5.1.1. Экран входа:
Фон: #FFFFFF / #1C2526, логотип (иконка чата 64x64px, #007AFF / #00C4CC, центрировано, отступ 32px сверху).
Поля:
'Имя пользователя': TextInput 48x300px, закругление 8px, фон #F2F2F7 / #354345, отступ 8px снизу.
'Пароль': TextInput 48x300px, закругление 8px, скрытие текста (иконка глаза 24x24px справа).
Кнопка 'Войти': 48x120px, закругление 8px, #007AFF / #00C4CC, текст 16px белый, отступ 16px сверху.
Ссылка 'Регистрация': текст 14px подчёркнутый, #007AFF / #00C4CC, центрировано, отступ 16px сверху.
Поведение: при ошибке — красный текст 14px под кнопкой (например, 'Неверный пароль'), fade-in 200ms.
Чекпоинт: Тест на рендеринг, ввод данных, переход на регистрацию, запись в progress.json.
5.1.2. Экран регистрации:
Фон и логотип: как в 5.1.1.
Поля: 'Имя пользователя', 'Пароль' (как в 5.1.1), 'Повторить пароль' (TextInput 48x300px).
Кнопка 'Зарегистрироваться': 48x120px, #007AFF / #00C4CC.
Ссылка 'Войти': текст 14px подчёркнутый, отступ 16px сверху.
Поведение: валидация (имя 3-20 символов, пароль 6-50 с буквой и цифрой), ошибка — красный текст 14px.
Чекпоинт: Тест на рендеринг, валидацию, успешную регистрацию, запись в progress.json.
5.2. Главный экран (список чатов)
5.2.1. Список чатов:
FlatList, отступы: 10px сверху/снизу, 8px между элементами.
Элемент:
Аватар: круг 48x48px, отступ 8px справа.
Название: 16px Roboto Medium, обрезка '...' (> 25 символов).
Последнее сообщение: 14px серый (#666666 / #A9A9A9), обрезка '...' (> 40 символов).
Счётчик: круг 20x20px, #007AFF / #00C4CC, текст 12px белый.
Заголовок: 'NexChat' 18px Roboto Bold, отступ 16px сверху, иконка меню (☰ 24x24px слева).
FAB 'Новый чат': круг 56x56px, '+' 24x24px, отступ 16px снизу/справа.
Чекпоинт: Тест на рендеринг списка, прокрутку, FAB, запись в progress.json.
5.2.2. Поиск и фильтры:
Поле поиска: TextInput 48x100%, закругление 24px, иконка лупы 24x24px слева, отступ 8px сверху.
Фильтры: кнопки 'Все', 'Личные', 'Группы' (48x80px, закругление 8px, активная — #007AFF / #00C4CC).
Поведение: фильтрация списка в реальном времени, анимация fade-in 200ms для результатов.
Чекпоинт: Тест на поиск, фильтры, анимацию, запись в progress.json.
5.3. Экран чата
5.3.1. Лента сообщений:
ScrollView, отступы 8px слева/справа, автопрокрутка к последнему сообщению.
Текст: закругление 8px, фон #E5E5EA / #2D3839 (чужие), #007AFF / #00C4CC (свои), 16px, ширина до 70%.
Медиа: фото/видео (200x200px), аудио/голосовое (200x20px), стикеры (150x150px).
Реакции: круг 24x24px, эмодзи + счётчик.
Заголовок: аватар 40x40px, название 18px Roboto Bold, 'Назад' (стрелка 24x24px), 'Инфо' (i 24x24px).
Чекпоинт: Тест на рендеринг ленты, прокрутку, запись в progress.json.
5.3.2. Полноэкранный режим медиа:
Фон: #000000, фото/видео 100% экрана, pinch-to-zoom до 3x.
Кнопки: 'Закрыть' (X 24x24px, верхний правый угол), видео — play/pause (48x48px), прогресс-бар (4px).
Чекпоинт: Тест на открытие, зум, воспроизведение видео, запись в progress.json.
5.3.3. Поле ввода и интерактивность:
TextInput: 48x70%, закругление 24px, фон #F2F2F7 / #354345.
Иконки: эмодзи (😊), стикеры (🎉, react-native-sticker-picker), файл (paperclip), микрофон (🎙).
Отправка: круг 40x40px, стрелка 20x20px, fade-in при тексте.
Поведение: долгое нажатие на сообщение → меню ('Ответить', 'Переслать', 'Удалить', 'Реакция').
Голосовое: удержание микрофона → запись, свайп вверх — отправка, влево — отмена.
Чекпоинт: Тест на ввод, отправку, меню, запись голосового, запись в progress.json.
5.4. Экран ботов и 'Эхо-пространства'
5.4.1. Экран ботов:
FlatList: [🤖] Name (16px), 'Настроить' (шестерёнка 20x20px).
FAB 'Добавить бота': 56x56px, '+' 24x24px.
Чекпоинт: Тест на рендеринг, переход к настройке, запись в progress.json.
5.4.2. Настройка бота:
Поля: 'Имя' (TextInput 48px), 'Команды' (FlatList), 'Webhook' (TextInput), 'Сохранить' (48x120px).
Чекпоинт: Тест на рендеринг, добавление команды, сохранение, запись в progress.json.
5.4.3. 'Эхо-пространство':
Tab Navigator: Tasks, Notes, Ideas (48px, подчёркивание 2px).
FlatList: задачи (дедлайн), заметки (теги), идеи (голоса).
Чекпоинт: Тест на рендеринг, переключение вкладок, запись в progress.json.
5.5. Экран звонков
5.5.1. Индивидуальный звонок:
Фон: #000000, видео/аватар 80% ширины, имя 18px белый, кнопки: mute, video, speaker (48x48px), end (64x64px, #FF3B30).
Чекпоинт: Тест на рендеринг, переключение кнопок, запись в progress.json.
5.5.2. Групповой звонок:
Сетка: 96x96px, до 5x10, активный спикер — рамка 2px #007AFF / #00C4CC.
Чекпоинт: Тест на рендеринг, отображение участников, запись в progress.json.
5.6. Панель управления
5.6.1. Основная структура:
Боковая панель: 300px (десктоп) / 80% (мобильный), #F7F7F7 / #2A3435, свайп вправо или ☰ 24x24px.
Вкладки (48px): 'Чаты', 'Боты', 'Эхо-пространство', 'Звонки', 'Настройки'.
Поведение: slide-in 300ms, закрытие свайпом влево или X 24x24px.
Чекпоинт: Тест на рендеринг, открытие/закрытие, запись в progress.json.
5.6.2. Управление чатами и ботами:
'Чаты': список групп, 'Редактировать' → имя, участники, бан-лист, 'Создать группу' (48x120px).
'Боты': список, 'Настроить' → команды, Webhook, 'Отключить' (#FF3B30).
Чекпоинт: Тест на рендеринг вкладок, редактирование, запись в progress.json.
5.6.3. 'Эхо-пространство' и звонки:
'Эхо-пространство': фильтры (Tasks/Notes/Ideas), 'Удалить выбранные' (корзина 24x24px).
'Звонки': история (дата, участники), настройки (микрофон/камера, битрейт).
Чекпоинт: Тест на рендеринг, фильтры, историю, запись в progress.json.
5.6.4. Настройки, стикеры и звуки:
'Настройки':
Тема (переключатель), уведомления (чекбоксы), язык (Dropdown), транскрибация (чекбокс).
'Стикеры': FlatList (64x64px), 'Добавить стикер' (имя, файл), 'Удалить' (✖ 16x16px).
'Звук уведомлений': плеер (200x20px), 'Выбрать звук', 'Сбросить' (#FF3B30).
Чекпоинт: Тест на рендеринг, переключение настроек, загрузку стикеров/звуков, запись в progress.json.
Подробные инструкции по написанию кода:
Последовательность работы:
Начинай с 1.1.1, переходи к следующему подэтапу после чекпоинта (код, тест, тестирование, progress.json).
Структура кода:
/src/server.js, /src/models/, /src/routes/, /src/utils/, /tests/, ES6 при поддержке.
Чекпоинты:
После каждого подэтапа:
Пиши тест (Jest): позитивные, негативные, граничные случаи.
Тестируй: запуск сервера, supertest для API, WebSocket-клиент, ручные проверки (curl/Postman).
Регистрируй в progress.json:
json


{"stage": 1, "substage": "1.1", "step": 1, "status": "completed", "description": "Сервер запущен", "completedAt": "2025-03-24T12:00:00Z"}
Используй fs для записи, при ошибке: 'Не удалось сохранить прогресс, продолжаю.'
Уведомления об изменениях:
Если редактируется файл из предыдущего подэтапа: 'Изменяется файл [имя] из подэтапа [номер]. Продолжить?'
Обработка ошибок:
Логи: console.log, console.error.
Тайм-ауты: 5 секунд, 'Operation timed out'.
Проверки: 400 при неверных данных.
Повторные попытки: 3 раза, интервал 1 секунда.
Тупики: остановка после 3 неудачных правок тестов, лимит итераций 1000.
Новая беседа:
Чтение progress.json, старт с незавершенного подэтапа.
Реакция на указания:
Переход к подэтапу, исправление ошибок, уточнения.
Вывод подэтапа:
Код, тест, инструкции (npm start, запросы, результат).
Начинай с Этапа 1.1.1."
